<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<title>Ova Kontrol Sistemi (KMZ)</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<!-- JSZip ve toGeoJSON -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tmcw/togeojson@5/dist/togeojson.umd.js"></script>

<!-- Turf -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<style>
  body { font-family: Arial; margin:0; padding:12px; background:#eef2f3; }
  .card { background:#fff; padding:12px; margin-bottom:10px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  input { padding:8px; width:200px; margin-right:10px; border-radius:6px; border:1px solid #ccc; }
  button { padding:9px 14px; border-radius:8px; border:0; background:#1976d2; color:white; cursor:pointer; }
  #map { height:62vh; margin-top:10px; border-radius:10px; }
</style>
</head>
<body>

<h2><b>Ova Kontrol Sistemi (KMZ TabanlÄ±)</b></h2>

<!-- KMZ YÃœKLEME -->
<div class="card">
  <b>1) Ova KMZ dosyasÄ±nÄ± yÃ¼kle</b><br><br>
  <input id="file" type="file" accept=".kmz,.kml">
  <div id="kmzName" style="margin-top:6px; font-weight:bold;"></div>
</div>

<!-- KOORDÄ°NAT GÄ°RÄ°ÅžÄ° -->
<div class="card">
  <b>2) Koordinat ile Ova Sorgula</b><br><br>
  <input id="lat" placeholder="Lat (Y)">
  <input id="lon" placeholder="Lon (X)">
  <button id="kontrolBtn">Kontrol Et</button>

  <div id="result" style="margin-top:12px; font-size:18px; font-weight:bold;"></div>
  <div id="ovaList" style="margin-top:4px;"></div>
</div>

<div id="map" class="card"></div>

<script>

// Harita oluÅŸtur
const map = L.map("map").setView([39, 35], 6);

L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

let ovaFeatures = [];
let ovaLayer = null;
let clickMarker = null;

// -----------------------------
// KMZ / KML DOSYASI YÃœKLEME
// -----------------------------
document.getElementById("file").addEventListener("change", async function(e){
  const f = e.target.files[0];
  if(!f) return;

  document.getElementById("kmzName").textContent = "YÃ¼kleniyor: " + f.name;

  try {
    const ext = f.name.split(".").pop().toLowerCase();
    let geojson;

    // KML ise
    if(ext === "kml"){
      const text = await f.text();
      const dom = new DOMParser().parseFromString(text,"text/xml");
      geojson = toGeoJSON.kml(dom);
    }

    // KMZ ise
    if(ext === "kmz"){
      const buf = await f.arrayBuffer();
      const zip = await JSZip.loadAsync(buf);

      // iÃ§indeki KML'yi bul
      const kmlName = Object.keys(zip.files).find(x => x.toLowerCase().endsWith(".kml"));
      const kmlText = await zip.files[kmlName].async("string");

      const dom = new DOMParser().parseFromString(kmlText,"text/xml");
      geojson = toGeoJSON.kml(dom);
    }

    loadOvaPolygons(geojson);
    document.getElementById("kmzName").textContent = "YÃ¼klendi: " + f.name;

  } catch(err){
    alert("KMZ yÃ¼klenemedi: " + err);
  }
});

// -----------------------------------
// OVA POLÄ°GONLARINI HARÄ°TAYA YÃœKLEME
// -----------------------------------
function loadOvaPolygons(geojson){

  if(ovaLayer) map.removeLayer(ovaLayer);

  ovaFeatures = geojson.features.filter(f =>
    f.geometry && (f.geometry.type === "Polygon" || f.geometry.type === "MultiPolygon")
  );

  ovaLayer = L.geoJSON(ovaFeatures,{
    style:{ color:"red", weight:2, fillOpacity:0.15 },
    onEachFeature:(feature,layer)=>{
      const name = feature.properties.name || "Ova AlanÄ±";
      layer.bindPopup("<b>Ova:</b> " + name);
    }
  }).addTo(map);

  map.fitBounds(ovaLayer.getBounds());
}

// -----------------------------------
// KOORDÄ°NAT Ä°LE SORGULAMA
// -----------------------------------
document.getElementById("kontrolBtn").addEventListener("click", function(){

  if(ovaFeatures.length === 0){
    alert("Ã–nce KMZ dosyasÄ±nÄ± yÃ¼kleyin.");
    return;
  }

  const lat = parseFloat(document.getElementById("lat").value);
  const lon = parseFloat(document.getElementById("lon").value);

  if(isNaN(lat) || isNaN(lon)){
    alert("GeÃ§erli koordinat girin.");
    return;
  }

  // Haritaya marker koy
  if(clickMarker) map.removeLayer(clickMarker);
  clickMarker = L.marker([lat,lon]).addTo(map);
  map.setView([lat,lon],16);

  checkPointInside(lat,lon);
});

// -----------------------------------
// HARÄ°TAYA TIKLAYINCA OTOMATÄ°K KOORDÄ°NAT AL
// -----------------------------------
map.on("click", function(e){
  const lat = e.latlng.lat.toFixed(7);
  const lon = e.latlng.lng.toFixed(7);

  document.getElementById("lat").value = lat;
  document.getElementById("lon").value = lon;

  if(clickMarker) map.removeLayer(clickMarker);
  clickMarker = L.marker([lat,lon]).addTo(map);

  checkPointInside(lat,lon);
});

// -----------------------------------
// NOKTA POLÄ°GON Ä°Ã‡Ä°NDE MÄ°?
// -----------------------------------
function checkPointInside(lat,lon){

  const pt = turf.point([lon,lat]);
  const insideList = [];

  ovaFeatures.forEach(f=>{
    if(turf.booleanPointInPolygon(pt,f)){
      insideList.push(f.properties.name || "Ova AlanÄ±");
    }
  });

  const result = document.getElementById("result");
  const list = document.getElementById("ovaList");

  if(insideList.length > 0){
    result.style.color = "green";
    result.textContent = "ðŸ“Œ Nokta OVA Ä°Ã‡Ä°NDE";

    list.innerHTML = "BulunduÄŸu Ova(lar):<br><b>" + insideList.join("<br>") + "</b>";

  } else {
    result.style.color = "red";
    result.textContent = "ðŸ“Œ Nokta OVA DIÅžINDA";
    list.innerHTML = "";
  }
}

</script>
</body>
</html>
