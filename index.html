<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<title>Ova Kontrol Uygulaması</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- JSZip (KMZ = ZIP okuyabilmek için) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- toGeoJSON (KML → GeoJSON dönüşümü) -->
<script src="https://unpkg.com/togeojson"></script>

<style>
body { margin:0; font-family: Arial; }
#map { height: 80vh; width: 100%; }
#panel {
    padding: 10px;
    background: #f5f5f5;
    border-top: 2px solid #ccc;
}
#result {
    padding: 10px;
    font-weight: bold;
    font-size: 18px;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="panel">
    <label>Enlem (Lat):</label>
    <input id="lat" type="text" style="width:120px;">
    <label>Boylam (Lon):</label>
    <input id="lon" type="text" style="width:120px;">
    <button onclick="checkPoint()">Kontrol Et</button>

    <div id="result"></div>
</div>

<script>
// GLOBAL Değişkenler
let map = L.map('map').setView([38.5, 35], 6); // Türkiye merkez
let ovaPolygons = []; // BOKA polygonları burada tutulacak

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
}).addTo(map);

// Haritaya tıklayınca Lat/Lon otomatik doldurulsun
map.on("click", function(e) {
    document.getElementById("lat").value = e.latlng.lat.toFixed(6);
    document.getElementById("lon").value = e.latlng.lng.toFixed(6);
});

// Nokta poligon içinde mi kontrol fonksiyonu
function pointInPolygon(point, polygon) {
    let x = point[1], y = point[0];
    let inside = false;

    for (let ring of polygon) {
        for (let i=0, j=ring.length - 1; i < ring.length; j=i++) {
            let xi = ring[i][1], yi = ring[i][0];
            let xj = ring[j][1], yj = ring[j][0];

            let intersect = ((yi > y) !== (yj > y)) &&
                (x < ((xj - xi) * (y - yi)) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
    }
    return inside;
}

async function loadKMZ() {
    try {
        const response = await fetch("boka.kmz");
        const data = await response.arrayBuffer();

        const zip = await JSZip.loadAsync(data);
        const kmlFile = Object.keys(zip.files).find(f => f.endsWith(".kml"));

        if (!kmlFile) {
            alert("KMZ içinde KML bulunamadı!");
            return;
        }

        const kmlText = await zip.files[kmlFile].async("text");

        // String → XML
        const parser = new DOMParser();
        const kmlXML = parser.parseFromString(kmlText, "text/xml");

        // XML → GeoJSON
        const geojson = toGeoJSON.kml(kmlXML);

        // Haritaya çiz
        L.geoJSON(geojson, {
            style: { color: "red", weight: 2 }
        }).addTo(map);

        // Poligonları kaydet
        geojson.features.forEach(f => {
            if (f.geometry.type === "Polygon") {
                ovaPolygons.push(f.geometry.coordinates);
            } else if (f.geometry.type === "MultiPolygon") {
                f.geometry.coordinates.forEach(p => ovaPolygons.push(p));
            }
        });

        console.log("Yüklenen polygon sayısı:", ovaPolygons.length);

    } catch (err) {
        console.error("KMZ okunamadı:", err);
        alert("KMZ okunurken hata oluştu. Detay konsolda.");
    }
}

// Kullanıcının verdiği noktayı kontrol et
function checkPoint() {
    let lat = parseFloat(document.getElementById("lat").value);
    let lon = parseFloat(document.getElementById("lon").value);

    if (isNaN(lat) || isNaN(lon)) {
        alert("Koordinatlar geçerli değil.");
        return;
    }

    let point = [lat, lon];
    let insideAny = false;

    for (let poly of ovaPolygons) {
        if (pointInPolygon(point, poly)) {
            insideAny = true;
            break;
        }
    }

    let div = document.getElementById("result");
    if (insideAny) {
        div.innerHTML = "✔ Bu nokta **OVA İÇİNDE**";
        div.style.color = "green";
    } else {
        div.innerHTML = "✘ Bu nokta **OVA DIŞINDA**";
        div.style.color = "red";
    }
}

// Uygulama açılınca KMZ yükle
loadKMZ();

</script>

</body>
</html>
