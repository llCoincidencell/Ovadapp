<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Ova Kontrol</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- JSZip (KMZ açmak için) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<!-- togeojson (KML → GeoJSON) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>

<style>
    body { margin: 0; padding: 0 }
    #map { width: 100vw; height: 100vh }
    #result {
        position: absolute;
        top: 10px; left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        background: white;
        border-radius: 8px;
        font-weight: bold;
        font-size: 18px;
        box-shadow: 0 0 10px rgba(0,0,0,0.3);
        z-index: 9999;
    }
</style>
</head>

<body>
<div id="result">Ovada mı? - Tıklayın</div>
<div id="map"></div>

<script>
// Harita başlat
const map = L.map('map').setView([36.85, 28.27], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let ovaPolygon = null;

// KMZ yükleme fonksiyonu
async function loadKMZ() {
    const url = "https://llcoincidencell.github.io/Ovadapp/boka.kmz";

    // KMZ indir
    const response = await fetch(url);
    const arrayBuffer = await response.arrayBuffer();

    // KMZ zip aç
    const zip = await JSZip.loadAsync(arrayBuffer);

    // KMZ içinde doc.kml bul
    const kmlFile = zip.file(/.kml$/i)[0];
    const kmlText = await kmlFile.async("text");

    // DOM parse
    const parser = new DOMParser();
    const kmlDom = parser.parseFromString(kmlText, "text/xml");

    // KML → GeoJSON
    const geo = toGeoJSON.kml(kmlDom);

    // Polygon al
    ovaPolygon = L.geoJSON(geo, {
        style: { color: "red", weight: 2 }
    }).addTo(map);

    // Haritayı polygon'a göre ortala
    map.fitBounds(ovaPolygon.getBounds());
}

function pointInPolygon(latlng, polygonLayer) {
    const poly = polygonLayer.getLayers()[0].getLatLngs()[0];

    let x = latlng.lng, y = latlng.lat;
    let inside = false;

    for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
        let xi = poly[i].lng, yi = poly[i].lat;
        let xj = poly[j].lng, yj = poly[j].lat;

        let intersect = ((yi > y) !== (yj > y)) &&
                        (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
    }
    return inside;
}

// Harita tıklama eventi
map.on("click", (e) => {
    if (!ovaPolygon) {
        alert("KMZ henüz yüklenmedi!");
        return;
    }

    const inside = pointInPolygon(e.latlng, ovaPolygon);

    const box = document.getElementById("result");
    if (inside) {
        box.innerHTML = "✔ OVA İÇİNDE";
        box.style.background = "#b2ffb2";
        box.style.color = "#006600";
    } else {
        box.innerHTML = "❌ OVA DIŞINDA";
        box.style.background = "#ffb2b2";
        box.style.color = "#660000";
    }
});

// KMZ yüklemeyi başlat
loadKMZ();
</script>
</body>
</html>
