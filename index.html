<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<title>Parsel â†’ Ova Kontrol (BOKA KMZ Sabit)</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<!-- JSZip + toGeoJSON -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.7.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tmcw/togeojson@5/dist/togeojson.umd.js"></script>

<!-- Turf.js -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<style>
  body { font-family: Arial; margin:0; padding:12px; background:#f1f5f9; }
  #map { height: 68vh; border-radius:10px; margin-top:10px; }
  .box { background:white; padding:12px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:10px; }
  input { width:150px; padding:7px; border-radius:6px; border:1px solid #ccc; }
  button { padding:7px 14px; border-radius:8px; border:0; background:#1976d2; color:white; cursor:pointer; }
</style>
</head>

<body>

<h2>BOKA â€“ Ova Ä°Ã§inde mi? (KMZ Otomatik YÃ¼klÃ¼)</h2>

<div class="box">
  <b>Koordinat Gir</b> (Haritaya tÄ±klayÄ±nca otomatik dolar)
  <br><br>
  Enlem (Lat): <input id="lat" placeholder="36.85">
  Boylam (Lon): <input id="lon" placeholder="28.27">
  <button onclick="kontrolEt()">Kontrol Et</button>
</div>

<div class="box" id="sonuc">SonuÃ§ bekleniyor...</div>

<div id="map"></div>

<script>
/* -------------------------------------
   HARÄ°TA
-------------------------------------- */
var map = L.map("map").setView([39,35], 6);
L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19 }).addTo(map);

var ovaLayers = null;
var ovaFeatures = [];

/* -------------------------------------
   KMZâ€™yi otomatik yÃ¼kle
   (aynÄ± klasÃ¶rde olduÄŸu iÃ§in direkt okunur)
-------------------------------------- */
async function loadKMZ(){
    try {
        const res = await fetch("boka.kmz");
        const buf = await res.arrayBuffer();
        const zip = await JSZip.loadAsync(buf);

        const kmlName = Object.keys(zip.files).find(f => f.endsWith(".kml"));
        if (!kmlName) { alert("KMZ iÃ§inde KML bulunamadÄ±!"); return; }

        const kmlText = await zip.files[kmlName].async("string");

        const dom = new DOMParser().parseFromString(kmlText,"text/xml");
        const gj = toGeoJSON.kml(dom);

        drawOvas(gj);

    } catch(e){
        console.error(e);
        alert("KMZ okuma hatasÄ±: " + e.message);
    }
}

function drawOvas(geojson){
    if (ovaLayers) map.removeLayer(ovaLayers);

    ovaFeatures = geojson.features.filter(
        f => f.geometry && (f.geometry.type === "Polygon" || f.geometry.type === "MultiPolygon")
    );

    ovaLayers = L.geoJSON(ovaFeatures, {
        style: { color:"#d9534f", weight:2, fillOpacity:0.15 },
        onEachFeature: (f, layer) => {
            const ad = f.properties.name || f.properties.Name || "Ova";
            layer.bindPopup("Ova: <b>"+ad+"</b>");
        }
    }).addTo(map);

    map.fitBounds(ovaLayers.getBounds());
}

/* -------------------------------------
   Haritaya tÄ±klayÄ±nca koordinat doldur
-------------------------------------- */
map.on("click", function(e){
    document.getElementById("lat").value = e.latlng.lat.toFixed(6);
    document.getElementById("lon").value = e.latlng.lng.toFixed(6);
});

/* -------------------------------------
   Kontrol et (turf.js point in polygon)
-------------------------------------- */
function kontrolEt(){
    const lat = Number(latInput.value);
    const lon = Number(lonInput.value);
    const sonucEl = document.getElementById("sonuc");

    if (isNaN(lat) || isNaN(lon)){
        alert("LÃ¼tfen geÃ§erli koordinat girin");
        return;
    }

    const p = turf.point([lon, lat]);
    let icindekiler = [];

    ovaFeatures.forEach(f=>{
        if (turf.booleanPointInPolygon(p,f)){
            const ad = f.properties.name || f.properties.Name || "Ova";
            icindekiler.push(ad);
        }
    });

    if (icindekiler.length > 0){
        sonucEl.innerHTML = 
           `ðŸ“Œ <b>OVA Ä°Ã‡Ä°NDE</b><br>â†’ ${icindekiler.join(", ")}`;
    } else {
        sonucEl.innerHTML = "ðŸ“Œ Ova dÄ±ÅŸÄ±nda";
    }
}

/* -------------------------------------
   BaÅŸlangÄ±Ã§ta KMZâ€™yi yÃ¼kle
-------------------------------------- */
loadKMZ();
</script>

</body>
</html>
